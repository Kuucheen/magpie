<p-card [styleClass]="styleClass">
  <ng-template pTemplate="header">
    <div class="flex justify-between items-center w-full p-3 gap-3">
      <h3 class="text-white m-0">{{ title }}</h3>
      <div class="tab-toggle">
        <button
          class="tab-btn"
          [class.active]="viewMode === 'map'"
          type="button"
          (click)="setViewMode('map')">
          Map
        </button>
        <button
          class="tab-btn"
          [class.active]="viewMode === 'countries'"
          type="button"
          (click)="setViewMode('countries')">
          Countries
        </button>
      </div>
    </div>
  </ng-template>

  @if (countries.length) {
    <div class="p-4">
      @if (viewMode === 'map') {
        <div class="map-panel">
          <div class="map-frame">
            <p-chart
              [type]="mapChartType"
              [data]="mapData"
              [options]="mapOptions"
              class="map-chart">
            </p-chart>
            <div class="map-overlay"></div>
          </div>
          <p class="map-caption text-neutral-500 text-xs mt-2 text-right">
            Lighter countries indicate more proxies.
          </p>
        </div>
      } @else {
        <div class="country-panel">
          <ul class="space-y-3">
            @for (c of visibleCountries(); track c.name) {
              <li class="country-row">
                <div class="flex items-center gap-3">
                  <span class="flag">{{ countryFlag(c) }}</span>
                  <span class="text-white font-medium truncate">{{ c.name }}</span>
                </div>
                <div class="text-right leading-tight">
                  <div class="text-white font-semibold text-sm">{{ c.percentage }}%</div>
                  @if (c.value !== undefined) {
                    <div class="text-neutral-500 text-xs">{{ c.value }} proxies</div>
                  }
                </div>
              </li>
            }
          </ul>
          @if (hasMoreCountries()) {
            <div class="flex justify-end mt-4">
              <button type="button" class="more-btn" (click)="showAllCountries = true">
                More
              </button>
            </div>
          }
        </div>
      }
    </div>
  } @else {
    <div class="flex flex-col items-center text-center gap-3 py-12 px-6 text-neutral-400">
      <i class="pi pi-chart-scatter text-3xl text-neutral-600"></i>
      <p class="max-w-xs text-sm">
        We will show where your proxies come from once we have country data to break down.
      </p>
    </div>
  }

  <p-dialog
    header="All countries"
    [(visible)]="showAllCountries"
    [modal]="true"
    [style]="{ width: '32rem', maxWidth: 'calc(100vw - 2rem)' }"
    [contentStyle]="{ padding: '0' }">
    <div class="all-countries-list p-4">
      <div class="search-wrapper mb-3">
        <input
          type="search"
          [(ngModel)]="searchTerm"
          class="search-input"
          placeholder="Search countries..."
          aria-label="Search countries">
      </div>
      <ul class="space-y-3 p-2">
        @for (c of filteredCountries(); track c.name) {
          <li class="country-row">
            <div class="flex items-center gap-3">
              <span class="flag">{{ countryFlag(c) }}</span>
              <span class="text-white font-medium truncate">{{ c.name }}</span>
            </div>
            <div class="text-right leading-tight">
              <div class="text-white font-semibold text-sm">{{ c.percentage }}%</div>
              @if (c.value !== undefined) {
                <div class="text-neutral-500 text-xs">{{ c.value }} proxies</div>
              }
            </div>
          </li>
        }
      </ul>
    </div>
  </p-dialog>
</p-card>
