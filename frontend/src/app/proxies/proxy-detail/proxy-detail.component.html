<div class="proxy-detail-page px-4 py-6 md:px-8 lg:px-10 text-gray-200">
  <a
    routerLink="/proxies"
    class="inline-flex items-center gap-2 rounded-full bg-neutral-900 border border-neutral-700 px-4 py-2 text-sm font-medium text-gray-300 hover:border-blue-500 hover:text-blue-300 transition-colors"
  >
    <i class="pi pi-arrow-left text-xs"></i>
    Back to proxies
  </a>

  <div class="mt-6 flex flex-col lg:flex-row gap-6 items-stretch">
    <section class="flex-1 min-w-[320px] bg-neutral-900 border border-neutral-800 rounded-2xl p-6 shadow">
      <div class="flex flex-wrap items-start gap-4">
        <div class="flex-1 min-w-0 w-full">
          <h1 class="text-2xl font-semibold text-white">
            Proxy
            <ng-container *ngIf="detail?.ip; else proxyIdHeading">
              <span class="proxy-address inline-flex items-center gap-1.5 flex-wrap ml-2 text-base">
                <button type="button" class="address-chip" (click)="copyIp()" title="Copy IP">
                  {{ detail?.ip }}
                </button>
                <ng-container *ngIf="detail?.port !== undefined && detail?.port !== null">
                  <span class="text-gray-500">:</span>
                  <button type="button" class="address-chip" (click)="copyPort()" title="Copy Port">
                    {{ detail?.port }}
                  </button>
                  <button
                    type="button"
                    pButton
                    icon="pi pi-copy"
                    class="copy-address-button"
                    (click)="copyFullAddress()"
                    title="Copy IP and port"
                  ></button>
                </ng-container>
              </span>
            </ng-container>
          </h1>
          <ng-template #proxyIdHeading>
            <span class="ml-2">{{ proxyId || '—' }}</span>
          </ng-template>
        </div>
        <span
          class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold uppercase tracking-wide flex-shrink-0 ml-auto"
          [ngClass]="{
            'bg-green-500/15 text-green-400': latestStatistic?.alive,
            'bg-red-500/15 text-red-400': latestStatistic && !latestStatistic.alive,
            'bg-neutral-700/40 text-gray-300': !latestStatistic
          }"
        >
          <span class="w-2 h-2 rounded-full"
                [ngClass]="{
                  'bg-green-400 animate-pulse': latestStatistic?.alive,
                  'bg-red-400': latestStatistic && !latestStatistic.alive,
                  'bg-gray-500': !latestStatistic
                }"
          ></span>
          {{ latestStatistic ? (latestStatistic.alive ? 'Alive' : 'Dead') : 'Unknown' }}
        </span>
        <div class="text-sm text-gray-400 flex flex-col sm:flex-row sm:items-center sm:gap-2 basis-full">
          <span class="shrink-0">Proxy ID {{ proxyId || '—' }}</span>
          <ng-container *ngIf="externalLookupLinks.length">
            <span class="hidden sm:inline text-gray-600" aria-hidden="true">|</span>
            <div class="flex flex-wrap items-center gap-2 mt-2 sm:mt-0 w-full sm:flex-1 sm:min-w-0">
              <ng-container *ngFor="let link of externalLookupLinks">
                <a
                  class="external-link-chip"
                  [href]="link.url"
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  <img [src]="link.icon" alt="" />
                  {{ link.label }}
                  <i class="pi pi-external-link"></i>
                </a>
              </ng-container>
            </div>
          </ng-container>
        </div>
      </div>

      <div class="mt-6">
        @if (isLoadingDetail) {
          <div class="flex justify-center py-10">
            <app-loading></app-loading>
          </div>
        } @else {
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
            <div class="detail-item">
              <div class="label">Country</div>
              <div class="value capitalize">{{ detail?.country || 'Unknown' }}</div>
            </div>
            <div class="detail-item">
              <div class="label">Estimated Type</div>
              <div class="value capitalize">{{ detail?.estimated_type || 'N/A' }}</div>
            </div>
            <div class="detail-item">
              <div class="label">Authentication</div>
              <div class="value break-all">{{ authenticationDisplay }}</div>
            </div>
            <div class="detail-item">
              <div class="label">Latest Protocol</div>
              <div class="value capitalize">{{ latestStatistic?.protocol || 'Unknown' }}</div>
            </div>
            <div class="detail-item">
              <div class="label">Anonymity</div>
              <div class="value capitalize">{{ latestStatistic?.anonymity_level || 'Unknown' }}</div>
            </div>
            <div class="detail-item">
              <div class="label">Latest Judge</div>
              <div class="value">{{ latestStatistic?.judge || 'Unknown' }}</div>
            </div>
            <div class="detail-item">
              <div class="label">Response Time</div>
              <div class="value">{{ latestStatistic?.response_time ?? '—' }}<span *ngIf="latestStatistic"> ms</span></div>
            </div>
            <div class="detail-item">
              <div class="label">Last Check</div>
              <div class="value">{{ detail?.latest_check ? (detail?.latest_check | date : 'medium') : 'Never' }}</div>
            </div>
            <div class="detail-item">
              <div class="label">Created</div>
              <div class="value">{{ detail?.created_at ? (detail?.created_at | date : 'medium') : 'Unknown' }}</div>
            </div>
          </div>
        }
      </div>
    </section>

    <section class="lg:w-[420px] bg-neutral-900 border border-neutral-800 rounded-2xl p-6 shadow flex flex-col">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-lg font-semibold text-white">Response Time</h2>
          <p class="text-xs text-gray-400">Most recent {{ chronologicalStats.length }} checks</p>
        </div>
      </div>

      <div class="flex-1 min-h-[220px]">
        @if (isLoadingStatistics) {
          <div class="flex justify-center items-center h-full"><app-loading></app-loading></div>
        } @else if (chartData?.datasets?.[0]?.data?.length) {
          <p-chart
            type="line"
            [data]="chartData"
            [options]="chartOptions"
            class="h-56 w-full"
          ></p-chart>
        } @else {
          <div class="flex items-center justify-center h-full text-sm text-gray-400">
            No statistics recorded yet.
          </div>
        }
      </div>
    </section>
  </div>

  <section class="mt-8 bg-neutral-900 border border-neutral-800 rounded-2xl p-6 shadow">
    <div class="flex items-center justify-between gap-4 flex-wrap">
      <div>
        <h2 class="text-lg font-semibold text-white">Proxy Statistic History</h2>
        <p class="text-xs text-gray-400">Chronological list of judge results</p>
      </div>
      <span class="text-xs text-gray-400">{{ statistics.length }} entries</span>
    </div>

    <div class="mt-4">
      @if (isLoadingStatistics) {
        <div class="flex justify-center py-8"><app-loading></app-loading></div>
      } @else {
        <p-table
          [value]="statistics"
          [tableStyleClass]="'proxy-stat-table'"
          [responsiveLayout]="'scroll'"
        >
          <ng-template pTemplate="header">
            <tr>
              <th>Checked At</th>
              <th>Status</th>
              <th>Response Time</th>
              <th>Attempt</th>
              <th>Protocol</th>
              <th>Anonymity</th>
              <th>Judge</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-row>
            <tr>
              <td>{{ row.created_at | date : 'medium' }}</td>
              <td>
                <div class="flex items-center gap-2">
                  <span class="w-2.5 h-2.5 rounded-full" [ngClass]="row.alive ? 'bg-green-400 animate-pulse' : 'bg-red-400'"></span>
                  <span class="text-sm">{{ row.alive ? 'Alive' : 'Dead' }}</span>
                </div>
              </td>
              <td>{{ row.response_time }} ms</td>
              <td>{{ row.attempt }}</td>
              <td class="capitalize">{{ row.protocol || 'Unknown' }}</td>
              <td class="capitalize">{{ row.anonymity_level || 'Unknown' }}</td>
              <td>{{ row.judge || 'Unknown' }}</td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="7" class="text-center py-6 text-gray-400">No statistics recorded yet.</td>
            </tr>
          </ng-template>
        </p-table>
      }
    </div>
  </section>
</div>
