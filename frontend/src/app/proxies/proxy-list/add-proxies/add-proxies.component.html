<div class="flex items-center">
  <p-button
    type="button"
    label="Add Proxies"
    icon="pi pi-plus"
    (onClick)="openDialog()"
  ></p-button>
</div>

<p-dialog
  [visible]="dialogVisible()"
  (visibleChange)="dialogVisible.set($event)"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [dismissableMask]="true"
  [breakpoints]="{ '960px': '90vw', '640px': '95vw' }"
  [style]="{ width: '60rem' }"
  [contentStyle]="{ padding: '0' }"
  (onHide)="onDialogHide()"
>
  <ng-template pTemplate="header">
    <div class="flex items-center gap-2 text-lg font-semibold">
      <span>Add Proxies</span>
      <app-tooltip [text]="'You can add proxies in the following formats:\n\nip:port\nip:port@username:password\nip:port:username:password'"></app-tooltip>
    </div>
  </ng-template>

  <div class="p-6 bg-neutral-900 text-gray-200">
    <div class="grid grid-cols-1 lg:grid-cols-[1.4fr_1fr] gap-6">
      <div class="space-y-5">
        <div class="flex flex-col gap-4">
          <div class="flex gap-2 w-full">
            <div class="flex-1">
              <p-button
                type="button"
                label="Paste from Clipboard"
                styleClass="w-full"
                (onClick)="pasteFromClipboard()"
                [disabled]="clipboardProxies() !== ''"
              ></p-button>
            </div>
            @if (clipboardProxies()) {
              <p-button
                type="button"
                styleClass="p-button-danger p-button-sm mt-1"
                icon="pi pi-times"
                (onClick)="clearClipboardProxies()"
              ></p-button>
            }
          </div>

          <div class="flex gap-2 w-full">
            <div class="flex-1">
              <p-button
                type="button"
                label="Import from File"
                styleClass="w-full"
                (onClick)="triggerFileInput(fileInput)"
                [disabled]="file() !== undefined"
              ></p-button>
              <input type="file" #fileInput (change)="onFileSelected($event)">
            </div>
            @if (file() !== undefined) {
              <p-button
                type="button"
                styleClass="p-button-danger p-button-sm mt-1"
                icon="pi pi-times"
                (onClick)="onFileClear()"
              ></p-button>
            }
          </div>
        </div>

        <div>
          <textarea
            maxlength="109999"
            placeholder="Bulk add Proxies&#10;127.0.0.1:66535"
            [ngModel]="proxyTextarea()"
            (ngModelChange)="onTextareaChange($event)"
            class="w-full h-48 p-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-400 resize-none theme-focus"
          ></textarea>
        </div>
      </div>

      <div class="bg-neutral-800 rounded-xl border border-neutral-700 p-6 flex flex-col items-center justify-center text-gray-200">
        @if (getProxiesWithoutAuthCount() + getProxiesWithAuthCount() > 0) {
          <div class="space-y-3 text-center">
            <div class="text-2xl font-semibold text-white">{{ getProxiesWithoutAuthCount() + getProxiesWithAuthCount() }}</div>
            <div class="text-sm uppercase tracking-wide text-gray-400">Total Proxies</div>
            <div class="flex flex-col gap-1">
              <span>Unique: {{ getUniqueProxiesCount() }}</span>
              <span>With Auth: {{ getProxiesWithAuthCount() }}</span>
            </div>
          </div>
        } @else {
          <div class="flex flex-col items-center gap-3 text-gray-500">
            <i class="pi pi-chart-line text-4xl"></i>
            <span class="text-sm">Add proxies to see stats here</span>
          </div>
        }
      </div>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="w-full flex justify-end gap-3 px-6 pb-4">
      <p-button type="button" label="Cancel" styleClass="p-button-text" (onClick)="closeDialog()"></p-button>
      <p-button
        type="button"
        label="Add Proxies to Queue"
        styleClass="p-button-success"
        (onClick)="submitProxies()"
        [disabled]="!file() && !proxyTextarea() && !clipboardProxies()"
      ></p-button>
    </div>
  </ng-template>
</p-dialog>

@if (showPopup()) {
  <app-procesing-popup
    [status]="popupStatus()"
    [count]="addedProxyCount()"
    [item]="'proxies'"
    [showDetailsButton]="hasUploadDetails()"
    [autoCloseOnSuccess]="!hasUploadDetails()"
    (closed)="onPopupClose()"
    (detailsRequested)="openDetails()"
  ></app-procesing-popup>
}

<p-dialog
  [visible]="detailsVisible()"
  (visibleChange)="detailsVisible.set($event)"
  [modal]="true"
  [draggable]="true"
  [resizable]="false"
  [dismissableMask]="true"
  [baseZIndex]="1300"
  [breakpoints]="{ '960px': '90vw', '640px': '95vw' }"
  [style]="{ width: '32rem' }"
  [contentStyle]="{ padding: '0' }"
>
  <ng-template pTemplate="header">
    <div class="flex items-center gap-2 text-lg font-semibold">
      <span>Upload details</span>
    </div>
  </ng-template>

  <div class="p-6 bg-neutral-900 text-gray-200">
    @if (uploadDetails()) {
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
          <div class="text-gray-400">Total entries</div>
          <div class="text-right font-semibold text-white">{{ uploadDetails()?.submittedCount }}</div>

          <div class="text-gray-400">Parsed valid</div>
          <div class="text-right font-semibold text-white">{{ uploadDetails()?.parsedCount }}</div>

          <div class="text-gray-400">Added</div>
          <div class="text-right font-semibold text-white">{{ addedProxyCount() }}</div>

          <div class="text-gray-400">Blacklisted</div>
          <div class="text-right font-semibold text-white">{{ uploadDetails()?.blacklistedCount }}</div>

          <div class="text-gray-400">Invalid IPv4</div>
          <div class="text-right font-semibold text-white">{{ uploadDetails()?.invalidIpv4Count }}</div>

          <div class="text-gray-400">Invalid IP</div>
          <div class="text-right font-semibold text-white">{{ uploadDetails()?.invalidIpCount }}</div>

          <div class="text-gray-400">Invalid port</div>
          <div class="text-right font-semibold text-white">{{ uploadDetails()?.invalidPortCount }}</div>

          <div class="text-gray-400">Invalid format</div>
          <div class="text-right font-semibold text-white">{{ uploadDetails()?.invalidFormatCount }}</div>

          <div class="text-gray-400">Processing time</div>
          <div class="text-right font-semibold text-white">{{ formatDuration(uploadDetails()?.processingMs) }}</div>
        </div>
        <div class="text-xs text-gray-500">Counts exclude blank lines and whitespace.</div>
      </div>
    } @else {
      <div class="text-sm text-gray-400">No details available for this upload.</div>
    }
  </div>
</p-dialog>
