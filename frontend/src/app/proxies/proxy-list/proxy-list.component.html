@if (!hasLoaded) {
  <app-loading class="flex items-center justify-center mt-20"></app-loading>
} @else {
  <div class="proxy-container p-8 min-h-screen bg-gray-900 text-gray-300">
    <!-- Delete and Export Buttons -->
    <div class="actions mb-4 flex gap-4">
      <p-button
        label="Delete Selected"
        icon="pi pi-trash"
        styleClass="p-button-danger"
        (onClick)="deleteSelectedProxies()"
        [disabled]="!selection.hasValue()"
      ></p-button>

      <p-button
        label="Export Proxies"
        icon="pi pi-upload"
        styleClass="p-button-primary"
        (onClick)="openExportDialog()"
        [disabled]="!dataSource.data.length"
      ></p-button>
    </div>

    <p-table
      [value]="dataSource.data"
      [paginator]="true"
      [rows]="40"
      [totalRecords]="totalItems"
      [lazy]="true"
      (onLazyLoad)="onLazyLoad($event)"
      [rowsPerPageOptions]="[20, 40, 60, 100]"
      [selection]="selection.selected"
      [(selection)]="selectedProxies"
      dataKey="id"
      class="p-datatable-gridlines p-datatable-sm"
      [sortField]="sortField"
      [sortOrder]="sortOrder ?? 0"
      (onSort)="onSort($event)"
    >
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 3rem">
            <p-checkbox
              [binary]="true"
              (onChange)="masterToggle()"
              [ngModel]="isAllSelected()"
            ></p-checkbox>
          </th>
          <th pSortableColumn="alive">
            Status <p-sortIcon field="alive"></p-sortIcon>
          </th>
          <th pSortableColumn="ip">
            IP Address <p-sortIcon field="ip"></p-sortIcon>
          </th>
          <th pSortableColumn="port">
            Port <p-sortIcon field="port"></p-sortIcon>
          </th>
          <th pSortableColumn="response_time">
            Response Time <p-sortIcon field="response_time"></p-sortIcon>
          </th>
          <th pSortableColumn="estimated_type">
            Estimated Type <p-sortIcon field="estimated_type"></p-sortIcon>
          </th>
          <th pSortableColumn="country">
            Country <p-sortIcon field="country"></p-sortIcon>
          </th>
          <th pSortableColumn="protocol">
            Protocol <p-sortIcon field="protocol"></p-sortIcon>
          </th>
          <th pSortableColumn="latest_check">
            Last Check <p-sortIcon field="latest_check"></p-sortIcon>
          </th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-proxy>
        <tr (click)="toggleSelection(proxy)" [pSelectableRow]="proxy">
          <td>
            <p-checkbox
              [binary]="true"
              (onChange)="toggleSelection(proxy)"
              [ngModel]="selection.isSelected(proxy)"
            ></p-checkbox>
          </td>
          <td>
            <div
              class="status-dot w-3 h-3 rounded-full inline-block"
              [class.bg-green-500]="proxy.alive"
              [class.shadow-green-500]="proxy.alive"
              [class.animate-pulse]="proxy.alive"
              [class.bg-red-500]="!proxy.alive"
            ></div>
          </td>
          <td>{{ proxy.ip }}</td>
          <td>{{ proxy.port }}</td>
          <td>{{ proxy.response_time }} ms</td>
          <td>{{ proxy.estimated_type }}</td>
          <td>{{ proxy.country }}</td>
          <td>{{ proxy.protocol }}</td>
          <td>{{ proxy.latest_check | date : 'short' }}</td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptyMessage">
        <tr>
          <td [attr.colspan]="displayedColumns.length + 1">No proxies found.</td>
        </tr>
      </ng-template>
    </p-table>
  </div>
}
