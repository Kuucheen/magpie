<div class="rotating-proxies-page text-gray-200">
  <section class="rotating-panel bg-neutral-900 border border-neutral-800 rounded-2xl p-6 shadow-lg">
    <header class="panel-header flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <h2 class="text-xl font-semibold text-white mb-1">Rotating Proxies</h2>
        <p class="text-sm text-gray-400 max-w-3xl">
          Spin up protocol-specific rotators, gate them with authentication, and pull fresh proxies on demand.
        </p>
      </div>
      <p-button
        type="button"
        label="Refresh"
        icon="pi pi-refresh"
        [disabled]="loading()"
        (onClick)="loadInitialData()"
        styleClass="refresh-button"
      >
      </p-button>
    </header>

    <div class="panel-grid">
      <section class="section-card create-card bg-neutral-950/40 border border-neutral-800 rounded-xl p-5">
        <div class="section-header flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between">
          <div>
            <h3 class="section-title">Create Rotator</h3>
            <p class="section-hint">Generate a rotating endpoint with optional filters and credentials.</p>
          </div>
          <span class="pill subtle-pill">Ports auto-assigned</span>
        </div>

        <form [formGroup]="createForm" (ngSubmit)="createRotator()" class="create-form">
          @if (noProtocolsAvailable()) {
            <div class="form-alert">
              Enable at least one protocol in your account settings to create a rotator.
            </div>
          }
          @if (!hasAvailableInstances()) {
            <div class="form-alert">
              No instance currently has free rotator ports. Free ports on an instance before creating a new rotator.
            </div>
          }

          <div class="create-layout">
            <div class="flow-column">
              <section class="form-section">
                <p class="section-step">Step 1</p>
                <h4 class="subsection-title">Basics</h4>
                <p class="subsection-hint">Choose a clear name so this endpoint is easy to find later.</p>
                <div class="field-group">
                  <label class="field-label" for="rotatorName">Name</label>
                  <input id="rotatorName"
                         type="text"
                         pInputText
                         class="p-inputtext-sm w-full"
                         placeholder="My rotating proxy"
                         maxlength="120"
                         formControlName="name">
                  @if (createForm.get('name')?.invalid && (createForm.get('name')?.dirty || createForm.get('name')?.touched)) {
                    <p class="field-error">Name is required and must be under 120 characters.</p>
                  }
                </div>
              </section>

              <section class="form-section">
                <p class="section-step">Step 2</p>
                <h4 class="subsection-title">How Clients Connect</h4>
                <p class="subsection-hint">Set the protocol and transport clients use for the rotator endpoint.</p>
                <div class="form-row">
                  <div class="field-group">
                    <label class="field-label" for="listenProtocol">Rotator Protocol</label>
                    <p-select inputId="listenProtocol"
                              class="w-full"
                              [options]="listenProtocolOptions()"
                              optionLabel="label"
                              optionValue="value"
                              placeholder="Select a protocol"
                              formControlName="listenProtocol">
                    </p-select>
                  </div>
                  <div class="field-group">
                    <label class="field-label" for="listenTransportProtocol">
                      Rotator Transport
                      <app-tooltip [text]="transportProtocolTooltip"></app-tooltip>
                    </label>
                    <p-select inputId="listenTransportProtocol"
                              class="w-full"
                              [options]="transportProtocolOptions"
                              optionLabel="label"
                              optionValue="value"
                              placeholder="Select a transport"
                              formControlName="listenTransportProtocol">
                      <ng-template pTemplate="selectedItem" let-option>
                        @if (option) {
                          <div class="transport-option">
                            <span>{{ option.label }}</span>
                            @if (option.value === 'tcp') {
                              <p-chip class="transport-chip">Default</p-chip>
                            }
                          </div>
                        }
                      </ng-template>
                      <ng-template pTemplate="item" let-option>
                        <div class="transport-option">
                          <span>{{ option.label }}</span>
                          @if (option.value === 'tcp') {
                            <p-chip class="transport-chip">Default</p-chip>
                          }
                        </div>
                      </ng-template>
                    </p-select>
                  </div>
                </div>
              </section>

              <section class="form-section">
                <p class="section-step">Step 3</p>
                <h4 class="subsection-title">What The Rotator Serves</h4>
                <p class="subsection-hint">Pick the protocol and transport used when connecting to upstream proxies.</p>
                <div class="form-row">
                  <div class="field-group">
                    <label class="field-label" for="rotatorProtocol">Proxy Protocol</label>
                    <p-select inputId="rotatorProtocol"
                              class="w-full"
                              [options]="protocolOptions()"
                              optionLabel="label"
                              optionValue="value"
                              placeholder="Select a protocol"
                              formControlName="protocol">
                    </p-select>
                  </div>
                  <div class="field-group">
                    <label class="field-label" for="transportProtocol">
                      Proxy Transport
                      <app-tooltip [text]="transportProtocolTooltip"></app-tooltip>
                    </label>
                    <p-select inputId="transportProtocol"
                              class="w-full"
                              [options]="transportProtocolOptions"
                              optionLabel="label"
                              optionValue="value"
                              placeholder="Select a transport"
                              formControlName="transportProtocol">
                      <ng-template pTemplate="selectedItem" let-option>
                        @if (option) {
                          <div class="transport-option">
                            <span>{{ option.label }}</span>
                            @if (option.value === 'tcp') {
                              <p-chip class="transport-chip">Default</p-chip>
                            }
                          </div>
                        }
                      </ng-template>
                      <ng-template pTemplate="item" let-option>
                        <div class="transport-option">
                          <span>{{ option.label }}</span>
                          @if (option.value === 'tcp') {
                            <p-chip class="transport-chip">Default</p-chip>
                          }
                        </div>
                      </ng-template>
                    </p-select>
                  </div>
                </div>
              </section>

              <section class="form-section">
                <p class="section-step">Step 4</p>
                <h4 class="subsection-title">Choose Instance</h4>
                <p class="subsection-hint">Select the region/instance that will host this rotator endpoint.</p>
                <div class="field-group">
                  <label class="field-label" for="rotatorInstance">Instance</label>
                  <p-select inputId="rotatorInstance"
                            class="w-full"
                            [options]="instanceOptions()"
                            optionLabel="label"
                            optionValue="value"
                            placeholder="Select an instance"
                            formControlName="instanceId">
                  </p-select>
                  @if (createForm.get('instanceId')?.invalid && (createForm.get('instanceId')?.dirty || createForm.get('instanceId')?.touched)) {
                    <p class="field-error">Please select an instance.</p>
                  } @else {
                    <p class="field-hint">Only instances with free rotator ports are shown.</p>
                  }
                </div>
              </section>
            </div>

            <aside class="support-column">
              <section class="form-section">
                <p class="section-step">Optional</p>
                <h4 class="subsection-title">Traffic Filters</h4>
                <p class="subsection-hint">Skip these if you want the broadest proxy pool.</p>
                <div class="field-group">
                  <label class="field-label" for="uptimePercentage">Uptime Filter</label>
                  <div class="uptime-controls">
                    <p-select inputId="uptimeFilterType"
                              class="w-full"
                              [options]="uptimeFilterTypeOptions"
                              optionLabel="label"
                              optionValue="value"
                              formControlName="uptimeFilterType">
                    </p-select>
                    <input id="uptimePercentage"
                           type="number"
                           pInputText
                           class="p-inputtext-sm w-full"
                           min="0"
                           max="100"
                           step="0.1"
                           placeholder="0-100"
                           formControlName="uptimePercentage">
                  </div>
                  @if (createForm.get('uptimePercentage')?.invalid && (createForm.get('uptimePercentage')?.dirty || createForm.get('uptimePercentage')?.touched)) {
                    <p class="field-error">Uptime percentage must be between 0 and 100.</p>
                  } @else {
                    <p class="field-hint">Leave empty to allow any uptime ratio.</p>
                  }
                </div>
                <div class="field-group">
                  <label class="field-label" for="reputationFilter">Reputation Filter</label>
                  <p-multiSelect inputId="reputationFilter"
                                 class="w-full"
                                 formControlName="reputationLabels"
                                 [options]="reputationOptions"
                                 optionLabel="label"
                                 optionValue="value">
                  </p-multiSelect>
                  <p class="field-hint">Choose which proxy reputations this rotator can use.</p>
                </div>
              </section>

              <section class="form-section auth-section">
                <h4 class="subsection-title">Authentication</h4>
                <p class="subsection-hint">Require credentials before clients can use this rotator.</p>
                <label class="auth-toggle">
                  <input type="checkbox" formControlName="authRequired">
                  <span>Require authentication</span>
                </label>

                @if (authEnabled()) {
                  <div class="auth-grid">
                    <div class="field-group">
                      <label class="field-label" for="authUsername">Auth Username</label>
                      <input id="authUsername"
                             type="text"
                             pInputText
                             class="p-inputtext-sm w-full"
                             maxlength="120"
                             formControlName="authUsername">
                    </div>

                    <div class="field-group">
                      <label class="field-label" for="authPassword">Auth Password</label>
                      <input id="authPassword"
                             type="text"
                             pInputText
                             class="p-inputtext-sm w-full"
                             maxlength="120"
                             formControlName="authPassword">
                    </div>
                  </div>
                }
              </section>

              <section class="form-section summary-section">
                <h4 class="subsection-title">Request Summary</h4>
                <p class="subsection-hint">Quick sanity check before creating the rotator.</p>
                <div class="summary-list">
                  <div class="summary-item">
                    <span class="summary-label">Rotator</span>
                    <span class="summary-value">
                      {{ protocolLabel(createForm.get('listenProtocol')?.value ?? '') || 'Not set' }}
                      /
                      {{ transportLabel(createForm.get('listenTransportProtocol')?.value ?? '') || 'Not set' }}
                    </span>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">Serves</span>
                    <span class="summary-value">
                      {{ protocolLabel(createForm.get('protocol')?.value ?? '') || 'Not set' }}
                      /
                      {{ transportLabel(createForm.get('transportProtocol')?.value ?? '') || 'Not set' }}
                    </span>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">Instance</span>
                    <span class="summary-value">{{ instanceSummary(createForm.get('instanceId')?.value) }}</span>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">Reputation</span>
                    <span class="summary-value">{{ reputationFilterSummary(createForm.get('reputationLabels')?.value) }}</span>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">Uptime</span>
                    <span class="summary-value">{{ uptimeFilterSummary(createForm.get('uptimeFilterType')?.value, createForm.get('uptimePercentage')?.value) }}</span>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">Auth</span>
                    <span class="summary-value">{{ createForm.get('authRequired')?.value ? 'Required' : 'Not required' }}</span>
                  </div>
                </div>
              </section>
            </aside>
          </div>

          <div class="form-footer flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <p class="field-hint mb-0">Ports are assigned automatically after creation.</p>
            <button pButton
                    type="submit"
                    label="Create Rotator"
                    icon="pi pi-plus"
                    [disabled]="createForm.invalid || submitting() || noProtocolsAvailable() || !hasAvailableInstances()"
                    [loading]="submitting()">
            </button>
          </div>
        </form>
      </section>
    </div>

    <section class="section-card list-card bg-neutral-950/40 border border-neutral-800 rounded-xl p-5 mt-4">
      <div class="section-header flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between">
        <div>
          <h3 class="section-title">Existing Rotators</h3>
          <p class="section-hint">Manage endpoints, rotate them manually, or remove what you no longer need.</p>
        </div>
        <div class="pill">
          @if (!hasLoaded()) {
            <p-skeleton width="3.5rem" height="0.75rem"></p-skeleton>
          } @else {
            {{ rotatingProxies().length }} total
          }
        </div>
      </div>

      <div class="table-shell">
        <p-table
          [value]="rotatingProxies()"
          [tableStyle]="{'min-width': '760px'}"
          responsiveLayout="scroll"
          class="rotators-table"
          [loading]="loading()"
          [showLoader]="hasLoaded()"
        >
          <ng-template pTemplate="header">
            <tr>
              <th>Name</th>
              <th>Filters</th>
              <th>Protocols</th>
              <th>Access</th>
              <th>Health</th>
              <th class="actions">Actions</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="loadingbody">
            @if (!hasLoaded()) {
              @for (row of skeletonRows; track $index) {
                <tr class="rotator-skeleton-row">
                  <td>
                    <div class="rotator-skeleton-name">
                      <p-skeleton width="8.5rem" height="0.9rem"></p-skeleton>
                      <p-skeleton width="7rem" height="0.7rem"></p-skeleton>
                    </div>
                  </td>
                  <td>
                    <div class="rotator-skeleton-access">
                      <p-skeleton width="12rem" height="0.85rem"></p-skeleton>
                      <p-skeleton width="12rem" height="0.85rem"></p-skeleton>
                      <p-skeleton width="10rem" height="0.85rem"></p-skeleton>
                    </div>
                  </td>
                  <td>
                    <div class="rotator-skeleton-access">
                      <p-skeleton width="10rem" height="0.85rem"></p-skeleton>
                      <p-skeleton width="10rem" height="0.85rem"></p-skeleton>
                    </div>
                  </td>
                  <td>
                    <div class="rotator-skeleton-access">
                      <p-skeleton width="8rem" height="0.85rem"></p-skeleton>
                      <p-skeleton width="6rem" height="0.65rem"></p-skeleton>
                    </div>
                  </td>
                  <td>
                    <div class="rotator-skeleton-access">
                      <p-skeleton width="2.5rem" height="0.95rem"></p-skeleton>
                      <p-skeleton width="5.5rem" height="0.65rem"></p-skeleton>
                    </div>
                  </td>
                  <td class="actions">
                    <div class="rotator-skeleton-actions">
                      <p-skeleton width="2.2rem" height="2.2rem" borderRadius="999px"></p-skeleton>
                      <p-skeleton width="2.2rem" height="2.2rem" borderRadius="999px"></p-skeleton>
                      <p-skeleton width="2.2rem" height="2.2rem" borderRadius="999px"></p-skeleton>
                    </div>
                  </td>
                </tr>
              }
            }
          </ng-template>
          <ng-template pTemplate="body" let-proxy>
            <tr>
              <td class="name-cell">
                <div class="name">{{ proxy.name }}</div>
                <div class="created">Created {{ proxy.created_at | date:'short' }}</div>
              </td>
              <td class="filters-cell">
                <div class="filter-line">
                  <span class="filter-label">Instance</span>
                  <span class="filter-value">{{ proxy.instance_name || proxy.instance_id || 'Unknown' }} · {{ proxy.instance_region || 'Unknown' }}</span>
                </div>
                <div class="filter-line">
                  <span class="filter-label">Reputation</span>
                  <span class="filter-value">{{ reputationFilterSummary(proxy.reputation_labels) }}</span>
                </div>
                <div class="filter-line">
                  <span class="filter-label">Uptime</span>
                  <span class="filter-value">{{ uptimeFilterSummary(proxy.uptime_filter_type, proxy.uptime_percentage) }}</span>
                </div>
              </td>
              <td class="protocols-cell">
                <div class="protocol-line">
                  <span class="line-label">Clients</span>
                  <div class="chip-inline">
                    <p-chip class="protocol-chip">{{ protocolLabel(proxy.listen_protocol ?? proxy.protocol) }}</p-chip>
                    @if (proxy.listen_transport_protocol ?? proxy.transport_protocol) {
                      <p-chip class="transport-chip">{{ transportLabel(proxy.listen_transport_protocol ?? proxy.transport_protocol ?? '') }}</p-chip>
                    }
                  </div>
                </div>
                <div class="protocol-line">
                  <span class="line-label">Upstream</span>
                  <div class="chip-inline">
                    <p-chip class="protocol-chip">{{ protocolLabel(proxy.protocol) }}</p-chip>
                    @if (proxy.transport_protocol) {
                      <p-chip class="transport-chip">{{ transportLabel(proxy.transport_protocol ?? '') }}</p-chip>
                    }
                  </div>
                </div>
              </td>
              <td class="access-cell">
                <div class="rotator-cell">
                  <button type="button"
                          pButton
                          class="p-button-text p-button-sm rotator-link"
                          [label]="rotatorEndpoint(proxy) || 'View details'"
                          (click)="showRotatorDetails(proxy)"
                          [disabled]="!rotatorEndpoint(proxy)">
                  </button>
                  <span class="muted hint-text">Click to view credentials</span>
                </div>
              </td>
              <td class="health-cell">
                <div class="alive-count">{{ proxy.alive_proxy_count }}</div>
                <span class="muted health-hint">matching proxies</span>
              </td>
              <td class="actions">
                <div class="action-buttons">
                  <button pButton type="button"
                          class="p-button-rounded p-button-text action-icon action-icon-details"
                          icon="pi pi-eye"
                          pTooltip="View details"
                          tooltipPosition="top"
                          aria-label="Details"
                          (click)="showRotatorDetails(proxy)"
                          [disabled]="isRotating(proxy.id)">
                  </button>
                  <button pButton type="button"
                          class="p-button-rounded p-button-text action-icon action-icon-rotate"
                          icon="pi pi-sync"
                          pTooltip="Rotate now"
                          tooltipPosition="top"
                          aria-label="Rotate"
                          (click)="rotate(proxy)"
                          [loading]="isRotating(proxy.id)"
                          [disabled]="isRotating(proxy.id)">
                  </button>
                  <button pButton type="button"
                          class="p-button-rounded p-button-text action-icon action-icon-delete"
                          icon="pi pi-trash"
                          pTooltip="Delete rotator"
                          tooltipPosition="top"
                          aria-label="Delete"
                          severity="danger"
                          (click)="deleteProxy(proxy)"
                          [disabled]="isRotating(proxy.id)">
                  </button>
                </div>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="6">
                <div class="empty-state">
                  <p>No rotating proxies yet.</p>
                  <p class="field-hint">Create one above to start rotating through healthy proxies.</p>
                </div>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </section>

  </section>
</div>

<p-dialog
  [visible]="detailsVisible()"
  (visibleChange)="detailsVisible.set($event)"
  [modal]="true"
  [dismissableMask]="true"
  [style]="{width: '625px'}"
  [breakpoints]="{'960px': '70vw', '640px': '90vw'}"
  (onHide)="onDetailsHide()"
  [header]="selectedRotator() ? selectedRotator()?.name + ' · ' + protocolLabel(selectedRotator()?.listen_protocol ?? selectedRotator()?.protocol ?? '') : 'Rotator Details'">
  @if (selectedRotator()) {
    <div class="details-dialog mt-4">
      <div class="details-grid">
        <div class="detail-row">
          <span class="label">Endpoint</span>
          <span class="value">{{ rotatorEndpoint(selectedRotator()) }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Instance</span>
          <span class="value">
            {{ selectedRotator()?.instance_name || selectedRotator()?.instance_id || 'Unknown' }}
            ·
            {{ selectedRotator()?.instance_region || 'Unknown' }}
          </span>
        </div>
        <div class="detail-row">
          <span class="label">Connection</span>
          @if (rotatorConnectionString(selectedRotator())) {
            <span class="value">{{ rotatorConnectionString(selectedRotator()) }}</span>
          } @else {
            <span class="value muted">Unavailable</span>
          }
        </div>
        <div class="detail-row">
          <span class="label">Rotator Protocol</span>
          <span class="value">
            @if (selectedRotator()?.listen_protocol ?? selectedRotator()?.protocol) {
              <p-chip class="protocol-chip">{{ protocolLabel(selectedRotator()?.listen_protocol ?? selectedRotator()?.protocol ?? '') }}</p-chip>
            } @else {
              <span class="muted">Unavailable</span>
            }
          </span>
        </div>
        <div class="detail-row">
          <span class="label">Rotator Transport</span>
          <span class="value">
            @if (selectedRotator()?.listen_transport_protocol ?? selectedRotator()?.transport_protocol) {
              <p-chip class="transport-chip">{{ transportLabel(selectedRotator()?.listen_transport_protocol ?? selectedRotator()?.transport_protocol ?? '') }}</p-chip>
            } @else {
              <span class="muted">Unavailable</span>
            }
          </span>
        </div>
        <div class="detail-row">
          <span class="label">Serves</span>
          <span class="value">
            @if (selectedRotator()?.protocol) {
              <p-chip class="protocol-chip">{{ protocolLabel(selectedRotator()?.protocol ?? '') }}</p-chip>
            } @else {
              <span class="muted">Unavailable</span>
            }
          </span>
        </div>
        <div class="detail-row">
          <span class="label">Proxy Transport</span>
          <span class="value">
            @if (selectedRotator()?.transport_protocol) {
              <p-chip class="transport-chip">{{ transportLabel(selectedRotator()?.transport_protocol ?? '') }}</p-chip>
            } @else {
              <span class="muted">Unavailable</span>
            }
          </span>
        </div>
        <div class="detail-row">
          <span class="label">Reputation Filter</span>
          <span class="value">{{ reputationFilterSummary(selectedRotator()?.reputation_labels) }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Uptime Filter</span>
          <span class="value">{{ uptimeFilterSummary(selectedRotator()?.uptime_filter_type, selectedRotator()?.uptime_percentage) }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Authentication</span>
          @if (selectedRotator()?.auth_required && selectedRotator()?.auth_username && selectedRotator()?.auth_password) {
            <span class="value">{{ selectedRotator()?.auth_username }} / {{ selectedRotator()?.auth_password }}</span>
          } @else if (selectedRotator()?.auth_required) {
            <span class="value muted">Credentials required</span>
          } @else {
            <span class="value muted">Not required</span>
          }
        </div>
      </div>

      <div class="details-actions">
        <button pButton type="button"
                label="Copy Connection"
                icon="pi pi-copy"
                (click)="copyRotatorConnection(selectedRotator())"
                [disabled]="!rotatorConnectionString(selectedRotator())">
        </button>
        <button pButton type="button"
                label="Copy Username"
                icon="pi pi-user"
                (click)="copyRotatorField(selectedRotator()?.auth_username, 'Username')"
                [disabled]="!selectedRotator()?.auth_username">
        </button>
        <button pButton type="button"
                label="Copy Password"
                icon="pi pi-lock"
                (click)="copyRotatorField(selectedRotator()?.auth_password, 'Password')"
                [disabled]="!selectedRotator()?.auth_password">
        </button>
      </div>
    </div>
  } @else {
    <div class="empty-details muted">Select a rotator to view details.</div>
  }
</p-dialog>
