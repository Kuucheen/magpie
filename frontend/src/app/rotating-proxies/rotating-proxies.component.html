@if (loading()) {
  <app-loading class="flex items-center justify-center mt-20"></app-loading>
} @else {
  <div class="rotating-proxies-page text-gray-200">
    <section class="rotating-panel bg-neutral-900 border border-neutral-800 rounded-2xl p-6 shadow-lg">
      <header class="panel-header flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h2 class="text-xl font-semibold text-white mb-1">Rotating Proxies</h2>
          <p class="text-sm text-gray-400 max-w-3xl">
            Spin up protocol-specific rotators, gate them with authentication, and pull fresh proxies on demand.
          </p>
        </div>
        <p-button
          type="button"
          label="Refresh"
          icon="pi pi-refresh"
          [disabled]="loading()"
          (onClick)="loadInitialData()"
          styleClass="refresh-button"
        >
        </p-button>
      </header>

      <div class="panel-grid">
        <section class="section-card create-card bg-neutral-950/40 border border-neutral-800 rounded-xl p-5">
          <div class="section-header flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between">
            <div>
              <h3 class="section-title">Create Rotator</h3>
              <p class="section-hint">Generate a rotating endpoint with optional filters and credentials.</p>
            </div>
            <span class="pill subtle-pill">Ports auto-assigned</span>
          </div>

          <form [formGroup]="createForm" (ngSubmit)="createRotator()" class="create-form flex flex-col gap-5">
            <div class="field-grid">
              <div class="field-group">
                <label class="field-label" for="rotatorName">Name</label>
                <input id="rotatorName"
                       type="text"
                       pInputText
                       class="p-inputtext-sm w-full"
                       placeholder="My rotating proxy"
                       maxlength="120"
                       formControlName="name">
                @if (createForm.get('name')?.invalid && (createForm.get('name')?.dirty || createForm.get('name')?.touched)) {
                      <p class="field-error">Name is required and must be under 120 characters.</p>
                }
              </div>

              <div class="field-group">
                <label class="field-label" for="listenProtocol">Rotator Protocol</label>
                <p-select inputId="listenProtocol"
                          class="w-full"
                          [options]="listenProtocolOptions()"
                          optionLabel="label"
                          optionValue="value"
                          placeholder="Select a protocol"
                          formControlName="listenProtocol">
                </p-select>
                <p class="field-hint">
                  @if (noProtocolsAvailable()) {
                    Enable at least one protocol in your account settings to create a rotator.
                  } @else {
                    This is how clients will connect to the rotating proxy itself.
                  }
                </p>
              </div>

              <div class="field-group">
                <label class="field-label" for="rotatorProtocol">Proxy Protocol</label>
                <p-select inputId="rotatorProtocol"
                          class="w-full"
                          [options]="protocolOptions()"
                          optionLabel="label"
                          optionValue="value"
                          placeholder="Select a protocol"
                          formControlName="protocol">
                </p-select>
                <p class="field-hint">
                  @if (noProtocolsAvailable()) {
                    Enable at least one protocol in your account settings to create a rotator.
                  } @else {
                    Choose which upstream proxy protocol this rotator should serve.
                  }
                </p>
              </div>

              <div class="field-group full">
                <label class="field-label" for="reputationFilter">Reputation Filter</label>
                <p-multiSelect inputId="reputationFilter"
                               class="w-full"
                               display="chip"
                               formControlName="reputationLabels"
                               [options]="reputationOptions"
                               optionLabel="label"
                               optionValue="value">
                </p-multiSelect>
                <p class="field-hint">Pick which proxy reputations this rotator can serve. Leave empty to use every available proxy.</p>
              </div>
            </div>

            <div class="auth-block">
              <div class="auth-top flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                <div>
                  <p class="field-label">Authentication</p>
                  <p class="field-hint">Require credentials before a client can use the rotator.</p>
                </div>
                <label class="auth-toggle">
                  <input type="checkbox" formControlName="authRequired">
                  <span>Require authentication</span>
                </label>
              </div>

              @if (authEnabled()) {
                <div class="auth-grid">
                  <div class="field-group">
                    <label class="field-label" for="authUsername">Auth Username</label>
                    <input id="authUsername"
                           type="text"
                           pInputText
                           class="p-inputtext-sm w-full"
                           maxlength="120"
                           formControlName="authUsername">
                  </div>

                  <div class="field-group">
                    <label class="field-label" for="authPassword">Auth Password</label>
                    <input id="authPassword"
                           type="text"
                           pInputText
                           class="p-inputtext-sm w-full"
                           maxlength="120"
                           formControlName="authPassword">
                  </div>
                </div>
              }
            </div>

            <div class="form-footer flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
              <p class="field-hint mb-0">Rotators will prefer healthy proxies that match your filters.</p>
              <button pButton
                      type="submit"
                      label="Create Rotator"
                      icon="pi pi-plus"
                      [disabled]="createForm.invalid || submitting() || noProtocolsAvailable()"
                      [loading]="submitting()">
              </button>
            </div>
          </form>
        </section>
      </div>

      <section class="section-card list-card bg-neutral-950/40 border border-neutral-800 rounded-xl p-5 mt-4">
        <div class="section-header flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between">
          <div>
            <h3 class="section-title">Existing Rotators</h3>
            <p class="section-hint">Manage endpoints, rotate them manually, or remove what you no longer need.</p>
          </div>
          <div class="pill">{{ rotatingProxies().length }} total</div>
        </div>

        <div class="table-shell">
          <p-table [value]="rotatingProxies()" [tableStyle]="{'min-width': '820px'}" responsiveLayout="scroll" class="rotators-table">
            <ng-template pTemplate="header">
              <tr>
                <th>Name</th>
                <th>Rotator</th>
                <th>Serves</th>
                <th>Rotator Access</th>
                <th>Alive Proxies</th>
                <th>Last Rotation</th>
                <th>Last Served Proxy</th>
                <th class="actions">Actions</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-proxy>
              <tr>
                <td class="name-cell">
                  <div class="name">{{ proxy.name }}</div>
                  <div class="created">Created {{ proxy.created_at | date:'short' }}</div>
                  <div class="reputation-filter">
                    <span class="filter-label">Reputation</span>
                    <span class="filter-value">{{ reputationFilterSummary(proxy.reputation_labels) }}</span>
                  </div>
                </td>
                <td>
                  <span class="protocol-tag">{{ protocolLabel(proxy.listen_protocol ?? proxy.protocol) }}</span>
                </td>
                <td>
                  <span class="protocol-tag">{{ protocolLabel(proxy.protocol) }}</span>
                </td>
                <td>
                  <div class="rotator-cell">
                    <button type="button"
                            pButton
                            class="p-button-text p-button-sm rotator-link"
                            [label]="rotatorEndpoint(proxy) || 'View details'"
                            (click)="showRotatorDetails(proxy)"
                            [disabled]="!rotatorEndpoint(proxy)">
                    </button>
                    <span class="muted hint-text">Click to view credentials</span>
                  </div>
                </td>
                <td>
                  <span class="alive-count">{{ proxy.alive_proxy_count }}</span>
                </td>
                <td>
                  @if (proxy.last_rotation_at) {
                    {{ proxy.last_rotation_at | date:'short' }}
                  } @else {
                    <span class="muted">Never</span>
                  }
                </td>
                <td>
                  @if (proxy.last_served_proxy) {
                    <code>{{ proxy.last_served_proxy }}</code>
                  } @else {
                    <span class="muted">Not rotated yet</span>
                  }
                </td>
                <td class="actions">
                  <div class="action-buttons">
                    <button pButton type="button"
                            icon="pi pi-sync"
                            label="Rotate"
                            (click)="rotate(proxy)"
                            [loading]="isRotating(proxy.id)"
                            [disabled]="isRotating(proxy.id)">
                    </button>
                    <button pButton type="button"
                            icon="pi pi-trash"
                            label="Delete"
                            severity="danger"
                            (click)="deleteProxy(proxy)"
                            [disabled]="isRotating(proxy.id)">
                    </button>
                  </div>
                </td>
              </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="8">
                  <div class="empty-state">
                    <p>No rotating proxies yet.</p>
                    <p class="field-hint">Create one above to start rotating through healthy proxies.</p>
                  </div>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </section>

    </section>
  </div>
}

<p-dialog
  [visible]="detailsVisible()"
  (visibleChange)="detailsVisible.set($event)"
  [modal]="true"
  [dismissableMask]="true"
  [style]="{width: '625px'}"
  [breakpoints]="{'960px': '70vw', '640px': '90vw'}"
  (onHide)="onDetailsHide()"
  [header]="selectedRotator() ? selectedRotator()?.name + ' Â· ' + protocolLabel(selectedRotator()?.listen_protocol ?? selectedRotator()?.protocol ?? '') : 'Rotator Details'">
  @if (selectedRotator()) {
    <div class="details-dialog mt-4">
      <div class="details-grid">
        <div class="detail-row">
          <span class="label">Endpoint</span>
          <span class="value">{{ rotatorEndpoint(selectedRotator()) }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Connection</span>
          @if (rotatorConnectionString(selectedRotator())) {
            <span class="value">{{ rotatorConnectionString(selectedRotator()) }}</span>
          } @else {
            <span class="value muted">Unavailable</span>
          }
        </div>
        <div class="detail-row">
          <span class="label">Rotator Protocol</span>
          <span class="value">{{ protocolLabel(selectedRotator()?.listen_protocol ?? selectedRotator()?.protocol ?? '') }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Serves</span>
          <span class="value">{{ protocolLabel(selectedRotator()?.protocol ?? '') }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Reputation Filter</span>
          <span class="value">{{ reputationFilterSummary(selectedRotator()?.reputation_labels) }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Authentication</span>
          @if (selectedRotator()?.auth_required && selectedRotator()?.auth_username && selectedRotator()?.auth_password) {
            <span class="value">{{ selectedRotator()?.auth_username }} / {{ selectedRotator()?.auth_password }}</span>
          } @else if (selectedRotator()?.auth_required) {
            <span class="value muted">Credentials required</span>
          } @else {
            <span class="value muted">Not required</span>
          }
        </div>
      </div>

      <div class="details-actions">
        <button pButton type="button"
                label="Copy Connection"
                icon="pi pi-copy"
                (click)="copyRotatorConnection(selectedRotator())"
                [disabled]="!rotatorConnectionString(selectedRotator())">
        </button>
        <button pButton type="button"
                label="Copy Username"
                icon="pi pi-user"
                (click)="copyRotatorField(selectedRotator()?.auth_username, 'Username')"
                [disabled]="!selectedRotator()?.auth_username">
        </button>
        <button pButton type="button"
                label="Copy Password"
                icon="pi pi-lock"
                (click)="copyRotatorField(selectedRotator()?.auth_password, 'Password')"
                [disabled]="!selectedRotator()?.auth_password">
        </button>
      </div>
    </div>
  } @else {
    <div class="empty-details muted">Select a rotator to view details.</div>
  }
</p-dialog>
