<div class="proxy-container p-8 min-h-screen text-gray-300">
  <div class="actions-wrapper">
    <div class="actions mb-4 flex flex-wrap items-center justify-between gap-4">
      <div class="flex flex-wrap items-center gap-4">
        <p-button
          label="Delete Selected"
          icon="pi pi-trash"
          styleClass="p-button-danger"
          [disabled]="getSelectionCount() === 0"
          (onClick)="deleteSelectedSources()"
        ></p-button>

        <span class="text-sm text-gray-400">
          Total: {{ totalItems }} sources
        </span>
      </div>

      <div class="flex flex-wrap items-center gap-4">
        <p-button
          label="Refresh"
          icon="pi pi-refresh"
          styleClass="p-button-outlined"
          (onClick)="refreshList()"
          [disabled]="loading"
        ></p-button>

        <div #columnToggleAnchor>
          <p-button
            label="Columns"
            icon="pi pi-table"
            styleClass="p-button-outlined"
            [disabled]="isSavingColumnPreferences()"
            (onClick)="openColumnPanel($event)"
          ></p-button>
        </div>

        <app-add-scrape-source
          (showAddScrapeSourcesMessage)="onShowAddScrapeSourcesMessage($event)"
          (scrapeSourcesAdded)="onScrapeSourcesAdded()"
        ></app-add-scrape-source>
      </div>
    </div>

    @if (columnPanelOpen) {
      <app-column-picker-panel
        #columnPanelRef
        class="column-panel"
        [columns]="scrapeSourceColumnDefinitions"
        [selectedColumnIds]="displayedColumns"
        [defaultColumnIds]="defaultScrapeSourceColumns"
        [saving]="isSavingColumnPreferences()"
        (cancel)="closeColumnPanel()"
        (save)="saveColumnPreferences($event)"
        (dragStarted)="onColumnEditorDragStart()"
        (dragEnded)="onColumnEditorDragEnd()"
      ></app-column-picker-panel>
    }
  </div>

  <p-table
    [value]="scrapeSources"
    [loading]="loading"
    [paginator]="true"
    [rows]="pageSize"
    [totalRecords]="totalItems"
    [lazy]="true"
    (onLazyLoad)="onLazyLoad($event)"
    [rowsPerPageOptions]="[20]"
    dataKey="id"
    [selection]="selection.selected"
    [(selection)]="selectedScrapeSources"
    class="scrape-source-table p-datatable-gridlines p-datatable-sm"
    [rowHover]="true"
    [showLoader]="hasLoaded"
  >
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 3rem">
          <p-checkbox
            [binary]="true"
            (onChange)="masterToggle()"
            [ngModel]="isAllSelected()"
            [disabled]="scrapeSources.length === 0"
            [indeterminate]="isSomeSelected()"
          ></p-checkbox>
        </th>
        @for (column of tableColumns(); track trackByColumn($index, column)) {
          @if (column.sortField) {
            <th [pSortableColumn]="column.sortField" class="text-center" [ngClass]="{'url-cell': column.id === 'url'}">
              {{ column.label }} <p-sortIcon [field]="column.sortField"></p-sortIcon>
            </th>
          } @else {
            <th class="text-center" [ngClass]="{'url-cell': column.id === 'url'}">
              {{ column.label }}
            </th>
          }
        }
      </tr>
    </ng-template>
    <ng-template pTemplate="loadingbody">
      @if (!hasLoaded) {
        @for (row of skeletonRows; track $index) {
          <tr class="scrape-skeleton-row">
            <td>
              <p-skeleton width="1.25rem" height="1.25rem" shape="circle"></p-skeleton>
            </td>
            @for (column of tableColumns(); track trackByColumn($index, column)) {
              @if (column.id === 'url') {
                <td>
                  <p-skeleton width="100%" height="0.85rem"></p-skeleton>
                </td>
              } @else if (column.id === 'proxy_count') {
                <td class="text-center">
                  <p-skeleton width="3rem" height="0.85rem" class="inline-block"></p-skeleton>
                </td>
              } @else if (column.id === 'health') {
                <td class="text-center">
                  <div class="health-skeleton">
                    <p-skeleton width="7rem" height="1.35rem" class="inline-block"></p-skeleton>
                    <p-skeleton width="4.5rem" height="0.6rem" class="inline-block"></p-skeleton>
                  </div>
                </td>
              } @else if (column.id === 'robots_check') {
                <td class="text-center">
                  <p-skeleton width="7.5rem" height="1.5rem" class="inline-block"></p-skeleton>
                </td>
              } @else {
                <td class="text-center">
                  <p-skeleton width="4.5rem" height="1.5rem" class="inline-block"></p-skeleton>
                </td>
              }
            }
          </tr>
        }
      }
    </ng-template>
    <ng-template pTemplate="body" let-source>
      <tr (click)="toggleSelection(source)" [pSelectableRow]="source">
        <td (click)="$event.stopPropagation()">
          <p-checkbox
            [binary]="true"
            (onChange)="toggleSelection(source)"
            [ngModel]="selection.isSelected(source)"
          ></p-checkbox>
        </td>
        @for (column of tableColumns(); track trackByColumn($index, column)) {
          @switch (column.id) {
            @case ('url') {
              <td class="url-cell">
                <a
                  [href]="source.url"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="scrape-url"
                  [title]="source.url"
                  (click)="$event.stopPropagation()"
                >
                  <span class="scrape-url-start">{{ source.urlHead }}</span><span class="scrape-url-end">{{ source.urlTail }}</span>
                </a>
              </td>
            }
            @case ('proxy_count') {
              <td class="text-center">
                {{ source.proxy_count | number }}
              </td>
            }
            @case ('health') {
              <td class="text-center health-td">
                <app-health-bar-cell
                  [aliveCount]="source.alive_count"
                  [deadCount]="source.dead_count"
                  [unknownCount]="source.unknown_count ?? null"
                  [total]="source.proxy_count"
                ></app-health-bar-cell>
              </td>
            }
            @case ('robots_check') {
              <td class="text-center">
                <p-button
                  label="Check robots.txt"
                  icon="pi pi-shield"
                  size="small"
                  [loading]="isCheckingRobots(source.id)"
                  styleClass="p-button-outlined p-button-secondary"
                  (onClick)="checkRobots(source, $event)"
                ></p-button>
              </td>
            }
            @case ('actions') {
              <td class="text-center" (click)="$event.stopPropagation()">
                <p-button
                  label="Details"
                  icon="pi pi-external-link"
                  styleClass="p-button-text p-button-sm"
                  (onClick)="onViewSource($event, source)"
                ></p-button>
              </td>
            }
          }
        }
      </tr>
    </ng-template>
    <ng-template pTemplate="emptyMessage">
      <tr>
        <td [attr.colspan]="tableColumnCount()">No scrape sources found.</td>
      </tr>
    </ng-template>
  </p-table>

</div>

<p-confirmDialog
  [style]="{width: '450px'}"
  [baseZIndex]="10000"
  rejectButtonStyleClass="p-button-outlined"
></p-confirmDialog>
