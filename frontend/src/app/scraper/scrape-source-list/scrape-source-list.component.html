<div class="proxy-container p-8 min-h-screen text-gray-300">
  <div class="actions mb-4 flex flex-wrap items-center justify-between gap-4">
    <div class="flex flex-wrap items-center gap-4">
      <p-button
        label="Delete Selected"
        icon="pi pi-trash"
        styleClass="p-button-danger"
        [disabled]="getSelectionCount() === 0"
        (onClick)="deleteSelectedSources()"
      ></p-button>

      <span class="text-sm text-gray-400">
        Total: {{ totalItems }} sources
      </span>
    </div>

    <div class="flex flex-wrap items-center gap-4">
      <p-button
        label="Refresh"
        icon="pi pi-refresh"
        styleClass="p-button-outlined"
        (onClick)="refreshList()"
        [disabled]="loading"
      ></p-button>

      <app-add-scrape-source
        (showAddScrapeSourcesMessage)="onShowAddScrapeSourcesMessage($event)"
        (scrapeSourcesAdded)="onScrapeSourcesAdded()"
      ></app-add-scrape-source>
    </div>
  </div>

  <p-table
    [value]="scrapeSources"
    [loading]="loading"
    [paginator]="true"
    [rows]="pageSize"
    [totalRecords]="totalItems"
    [lazy]="true"
    (onLazyLoad)="onLazyLoad($event)"
    [rowsPerPageOptions]="[20]"
    dataKey="id"
    [selection]="selection.selected"
    [(selection)]="selectedScrapeSources"
    class="scrape-source-table p-datatable-gridlines p-datatable-sm"
    [rowHover]="true"
    [showLoader]="hasLoaded"
  >
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 3rem">
          <p-checkbox
            [binary]="true"
            (onChange)="masterToggle()"
            [ngModel]="isAllSelected()"
            [disabled]="scrapeSources.length === 0"
            [indeterminate]="isSomeSelected()"
          ></p-checkbox>
        </th>
        <th pSortableColumn="url" class="url-cell">
          URL <p-sortIcon field="url"></p-sortIcon>
        </th>
        <th style="width: 9rem" class="text-center" pSortableColumn="proxy_count">
          Proxy Count <p-sortIcon field="proxy_count"></p-sortIcon>
        </th>
        <th style="width: 13rem" class="text-center" pSortableColumn="health">
          Health <p-sortIcon field="health"></p-sortIcon>
        </th>
        @if (respectRobotsEnabled) {
          <th style="width: 11rem" class="text-center">
            Robots Check
          </th>
        }
        <th style="width: 7rem" class="text-center">
          Details
        </th>
      </tr>
    </ng-template>
    <ng-template pTemplate="loadingbody">
      @if (!hasLoaded) {
        @for (row of skeletonRows; track $index) {
          <tr class="scrape-skeleton-row">
            <td>
              <p-skeleton width="1.25rem" height="1.25rem" shape="circle"></p-skeleton>
            </td>
            <td>
              <p-skeleton width="100%" height="0.85rem"></p-skeleton>
            </td>
            <td class="text-center">
              <p-skeleton width="3rem" height="0.85rem" class="inline-block"></p-skeleton>
            </td>
            <td class="text-center">
              <div class="health-skeleton">
                <p-skeleton width="7rem" height="1.35rem" class="inline-block"></p-skeleton>
                <p-skeleton width="4.5rem" height="0.6rem" class="inline-block"></p-skeleton>
              </div>
            </td>
            @if (respectRobotsEnabled) {
              <td class="text-center">
                <p-skeleton width="7.5rem" height="1.5rem" class="inline-block"></p-skeleton>
              </td>
            }
            <td class="text-center">
              <p-skeleton width="4.5rem" height="1.5rem" class="inline-block"></p-skeleton>
            </td>
          </tr>
        }
      }
    </ng-template>
    <ng-template pTemplate="body" let-source>
      <tr (click)="toggleSelection(source)" [pSelectableRow]="source">
        <td (click)="$event.stopPropagation()">
          <p-checkbox
            [binary]="true"
            (onChange)="toggleSelection(source)"
            [ngModel]="selection.isSelected(source)"
          ></p-checkbox>
        </td>
        <td class="url-cell">
          <a
            [href]="source.url"
            target="_blank"
            rel="noopener noreferrer"
            class="scrape-url"
            [title]="source.url"
            (click)="$event.stopPropagation()"
          >
            <span class="scrape-url-start">{{ source.urlHead }}</span><span class="scrape-url-end">{{ source.urlTail }}</span>
          </a>
        </td>
        <td class="text-center health-td">
          {{ source.proxy_count }}
        </td>
        <td class="text-center">
          <div class="health-cell">
            <div class="health-sub">{{ source.health.ratioLabel }}</div>
            <div class="health-bar" aria-hidden="true">
              <span class="health-bar__segment health-bar__segment--alive" [style.width.%]="source.health.alivePercent"></span>
              <span class="health-bar__segment health-bar__segment--dead" [style.width.%]="source.health.deadPercent"></span>
              <span class="health-bar__segment health-bar__segment--unknown" [style.width.%]="source.health.unknownPercent"></span>
            </div>
            <div class="health-hover">
              <div
                class="status-pill"
                [ngClass]="{
                  'status-pill--mixed': source.health.tone === 'mixed',
                  'status-pill--dead': source.health.tone === 'unhealthy',
                  'status-pill--unknown': source.health.tone === 'empty'
                }"
              >
                <span class="status-dot" [ngClass]="source.health.dotClass"></span>
                {{ source.health.label }}
              </div>
              <div class="health-counts">
                <span class="health-count health-count--alive">Alive {{ source.health.aliveCount }}</span>
                <span class="health-count health-count--dead">Dead {{ source.health.deadCount }}</span>
                <span class="health-count health-count--unknown">Unknown {{ source.health.unknownCount }}</span>
              </div>
            </div>
          </div>
        </td>
        @if (respectRobotsEnabled) {
          <td class="text-center">
            <p-button
              label="Check robots.txt"
              icon="pi pi-shield"
              size="small"
              [loading]="isCheckingRobots(source.id)"
              styleClass="p-button-outlined p-button-secondary"
              (onClick)="checkRobots(source, $event)"
            ></p-button>
          </td>
        }
        <td class="text-center" (click)="$event.stopPropagation()">
          <p-button
            label="Details"
            icon="pi pi-external-link"
            styleClass="p-button-text p-button-sm"
            (onClick)="onViewSource($event, source)"
          ></p-button>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptyMessage">
      <tr>
        <td [attr.colspan]="respectRobotsEnabled ? 6 : 5">No scrape sources found.</td>
      </tr>
    </ng-template>
  </p-table>
</div>

<p-confirmDialog
  [style]="{width: '450px'}"
  [baseZIndex]="10000"
  rejectButtonStyleClass="p-button-outlined"
></p-confirmDialog>
