<div class="proxy-container p-8 min-h-screen text-gray-300">
  <div class="actions-wrapper">
    <div class="actions mb-4 flex flex-wrap items-center justify-between gap-4">
      <div class="flex flex-wrap items-center gap-4">
        <p-button
          label="Delete Selected"
          icon="pi pi-trash"
          styleClass="p-button-danger"
          [disabled]="getSelectionCount() === 0"
          (onClick)="deleteSelectedSources()"
        ></p-button>

        <span class="text-sm text-gray-400">
          Total: {{ totalItems }} sources
        </span>
      </div>

      <div class="flex flex-wrap items-center gap-4">
        <p-button
          label="Refresh"
          icon="pi pi-refresh"
          styleClass="p-button-outlined"
          (onClick)="refreshList()"
          [disabled]="loading"
        ></p-button>

        <div #columnToggleAnchor>
          <p-button
            label="Columns"
            icon="pi pi-table"
            styleClass="p-button-outlined"
            [disabled]="isSavingColumnPreferences()"
            (onClick)="openColumnPanel($event)"
          ></p-button>
        </div>

        <app-add-scrape-source
          (showAddScrapeSourcesMessage)="onShowAddScrapeSourcesMessage($event)"
          (scrapeSourcesAdded)="onScrapeSourcesAdded()"
        ></app-add-scrape-source>
      </div>
    </div>

    @if (columnPanelOpen) {
      <div class="column-panel" #columnPanelRef>
        <div class="column-panel__header">
          <h3>Table Columns</h3>
          <p-button
            label="Reset"
            icon="pi pi-refresh"
            styleClass="p-button-text p-button-sm"
            (onClick)="resetColumnEditor()"
          ></p-button>
        </div>

        <div class="column-panel__section">
          <div class="column-panel__title">Visible</div>
          <div cdkDropList [cdkDropListData]="columnPanelVisible()" (cdkDropListDropped)="onColumnDrop($event)">
            @for (column of columnPanelVisible(); track column.id) {
              <div class="column-panel__row" cdkDrag (cdkDragStarted)="onColumnDragStart()" (cdkDragEnded)="onColumnDragEnd()">
                <div class="column-panel__row-main">
                  <span class="column-panel__drag-handle" cdkDragHandle>
                    <i class="pi pi-bars" aria-hidden="true"></i>
                  </span>
                  <div class="column-panel__label-wrap">
                    <span class="column-panel__label">{{ column.label }}</span>
                    @if (column.example) {
                      <span class="column-panel__example">{{ column.example }}</span>
                    }
                  </div>
                </div>
                <div class="column-panel__controls">
                  <p-button
                    icon="pi pi-eye-slash"
                    styleClass="p-button-text p-button-sm"
                    [disabled]="columnPanelVisible().length <= 1"
                    (onClick)="hideColumn(column.id)"
                  ></p-button>
                </div>
              </div>
            }
          </div>
        </div>

        <div class="column-panel__section">
          <div class="column-panel__title">Hidden</div>
          @if (columnPanelHidden().length === 0) {
            <div class="column-panel__empty">No hidden columns.</div>
          } @else {
            @for (column of columnPanelHidden(); track column.id) {
              <div class="column-panel__row">
                <div class="column-panel__label-wrap">
                  <span class="column-panel__label">{{ column.label }}</span>
                  @if (column.example) {
                    <span class="column-panel__example">{{ column.example }}</span>
                  }
                </div>
                <p-button
                  icon="pi pi-eye"
                  styleClass="p-button-text p-button-sm"
                  (onClick)="showColumn(column.id)"
                ></p-button>
              </div>
            }
          }
        </div>

        <div class="column-panel__footer">
          <p-button
            label="Cancel"
            styleClass="p-button-text"
            (onClick)="closeColumnPanel()"
          ></p-button>
          <p-button
            label="Save"
            icon="pi pi-check"
            [loading]="isSavingColumnPreferences()"
            (onClick)="saveColumnPreferences()"
          ></p-button>
        </div>
      </div>
    }
  </div>

  <p-table
    [value]="scrapeSources"
    [loading]="loading"
    [paginator]="true"
    [rows]="pageSize"
    [totalRecords]="totalItems"
    [lazy]="true"
    (onLazyLoad)="onLazyLoad($event)"
    [rowsPerPageOptions]="[20]"
    dataKey="id"
    [selection]="selection.selected"
    [(selection)]="selectedScrapeSources"
    class="scrape-source-table p-datatable-gridlines p-datatable-sm"
    [rowHover]="true"
    [showLoader]="hasLoaded"
  >
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 3rem">
          <p-checkbox
            [binary]="true"
            (onChange)="masterToggle()"
            [ngModel]="isAllSelected()"
            [disabled]="scrapeSources.length === 0"
            [indeterminate]="isSomeSelected()"
          ></p-checkbox>
        </th>
        @for (column of tableColumns(); track trackByColumn($index, column)) {
          @if (column.sortField) {
            <th [pSortableColumn]="column.sortField" class="text-center" [ngClass]="{'url-cell': column.id === 'url'}">
              {{ column.label }} <p-sortIcon [field]="column.sortField"></p-sortIcon>
            </th>
          } @else {
            <th class="text-center" [ngClass]="{'url-cell': column.id === 'url'}">
              {{ column.label }}
            </th>
          }
        }
      </tr>
    </ng-template>
    <ng-template pTemplate="loadingbody">
      @if (!hasLoaded) {
        @for (row of skeletonRows; track $index) {
          <tr class="scrape-skeleton-row">
            <td>
              <p-skeleton width="1.25rem" height="1.25rem" shape="circle"></p-skeleton>
            </td>
            @for (column of tableColumns(); track trackByColumn($index, column)) {
              @if (column.id === 'url') {
                <td>
                  <p-skeleton width="100%" height="0.85rem"></p-skeleton>
                </td>
              } @else if (column.id === 'proxy_count') {
                <td class="text-center">
                  <p-skeleton width="3rem" height="0.85rem" class="inline-block"></p-skeleton>
                </td>
              } @else if (column.id === 'health') {
                <td class="text-center">
                  <div class="health-skeleton">
                    <p-skeleton width="7rem" height="1.35rem" class="inline-block"></p-skeleton>
                    <p-skeleton width="4.5rem" height="0.6rem" class="inline-block"></p-skeleton>
                  </div>
                </td>
              } @else if (column.id === 'robots_check') {
                <td class="text-center">
                  <p-skeleton width="7.5rem" height="1.5rem" class="inline-block"></p-skeleton>
                </td>
              } @else {
                <td class="text-center">
                  <p-skeleton width="4.5rem" height="1.5rem" class="inline-block"></p-skeleton>
                </td>
              }
            }
          </tr>
        }
      }
    </ng-template>
    <ng-template pTemplate="body" let-source>
      <tr (click)="toggleSelection(source)" [pSelectableRow]="source">
        <td (click)="$event.stopPropagation()">
          <p-checkbox
            [binary]="true"
            (onChange)="toggleSelection(source)"
            [ngModel]="selection.isSelected(source)"
          ></p-checkbox>
        </td>
        @for (column of tableColumns(); track trackByColumn($index, column)) {
          @switch (column.id) {
            @case ('url') {
              <td class="url-cell">
                <a
                  [href]="source.url"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="scrape-url"
                  [title]="source.url"
                  (click)="$event.stopPropagation()"
                >
                  <span class="scrape-url-start">{{ source.urlHead }}</span><span class="scrape-url-end">{{ source.urlTail }}</span>
                </a>
              </td>
            }
            @case ('proxy_count') {
              <td class="text-center">
                {{ source.proxy_count | number }}
              </td>
            }
            @case ('health') {
              <td class="text-center health-td">
                <div
                  class="health-cell"
                  (mouseenter)="showHealthPopup($event, source)"
                  (mouseleave)="hideHealthPopup()"
                >
                  <div class="health-sub">{{ source.health.ratioLabel }}</div>
                  <div class="health-bar" aria-hidden="true">
                    <span class="health-bar__segment health-bar__segment--alive" [style.width.%]="source.health.alivePercent"></span>
                    <span class="health-bar__segment health-bar__segment--dead" [style.width.%]="source.health.deadPercent"></span>
                    <span class="health-bar__segment health-bar__segment--unknown" [style.width.%]="source.health.unknownPercent"></span>
                  </div>
                </div>
              </td>
            }
            @case ('robots_check') {
              <td class="text-center">
                <p-button
                  label="Check robots.txt"
                  icon="pi pi-shield"
                  size="small"
                  [loading]="isCheckingRobots(source.id)"
                  styleClass="p-button-outlined p-button-secondary"
                  (onClick)="checkRobots(source, $event)"
                ></p-button>
              </td>
            }
            @case ('actions') {
              <td class="text-center" (click)="$event.stopPropagation()">
                <p-button
                  label="Details"
                  icon="pi pi-external-link"
                  styleClass="p-button-text p-button-sm"
                  (onClick)="onViewSource($event, source)"
                ></p-button>
              </td>
            }
          }
        }
      </tr>
    </ng-template>
    <ng-template pTemplate="emptyMessage">
      <tr>
        <td [attr.colspan]="tableColumnCount()">No scrape sources found.</td>
      </tr>
    </ng-template>
  </p-table>

  @if (hoveredHealth) {
    <div
      class="health-tooltip"
      [style.left.px]="hoveredHealth.x"
      [style.top.px]="hoveredHealth.y"
    >
      <div
        class="status-pill"
        [ngClass]="{
          'status-pill--mixed': hoveredHealth.source.health.tone === 'mixed',
          'status-pill--dead': hoveredHealth.source.health.tone === 'unhealthy',
          'status-pill--unknown': hoveredHealth.source.health.tone === 'empty'
        }"
      >
        <span class="status-dot" [ngClass]="hoveredHealth.source.health.dotClass"></span>
        {{ hoveredHealth.source.health.label }}
      </div>
      <div class="health-counts">
      <span class="health-count health-count--alive">Alive {{ hoveredHealth.source.health.aliveCount | number }}</span>
      <span class="health-count health-count--dead">Dead {{ hoveredHealth.source.health.deadCount | number }}</span>
      <span class="health-count health-count--unknown">Unknown {{ hoveredHealth.source.health.unknownCount | number }}</span>
      </div>
    </div>
  }
</div>

<p-confirmDialog
  [style]="{width: '450px'}"
  [baseZIndex]="10000"
  rejectButtonStyleClass="p-button-outlined"
></p-confirmDialog>
