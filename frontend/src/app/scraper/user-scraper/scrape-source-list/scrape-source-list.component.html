@if (!hasLoaded) {
  <div class="flex items-center justify-center mt-20">
    <app-loading></app-loading>
  </div>
} @else {
  <div class="max-w-7xl mx-auto p-6 min-h-screen">
    <!-- Actions Bar -->
    <div class="flex justify-between items-center mb-6">
      <div class="flex gap-3">
        <p-button
          label="Delete Selected"
          icon="pi pi-trash"
          severity="danger"
          [disabled]="selectedSources.length === 0"
          (onClick)="deleteSelectedSources()"
          [badge]="getSelectionCount().toString()"
          [badgeClass]="selectedSources.length > 0 ? 'bg-red-500' : ''"
          pTooltip="Delete selected scrape sources"
          tooltipPosition="top">
        </p-button>
      </div>

      <div class="text-sm text-gray-600 dark:text-gray-400">
        Total: {{ totalItems }} sources
      </div>
    </div>

    <!-- Data Table -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
      <p-table
        [value]="scrapeSources"
        [loading]="loading"
        [paginator]="false"
        [sortMode]="'multiple'"
        [tableStyle]="{'min-width': '60rem'}"
        [(selection)]="selectedSources"
        [selectAll]="isAllSelected()"
        (selectAllChange)="onSelectAll($event)"
        styleClass="p-datatable-sm p-datatable-striped"
        [rowHover]="true">

        <!-- Header Template -->
        <ng-template pTemplate="header">
          <tr class="bg-gray-50 dark:bg-gray-700">
            <th class="w-16 text-center">
              <p-tableHeaderCheckbox
                [disabled]="scrapeSources.length === 0">
              </p-tableHeaderCheckbox>
            </th>
            <th class="text-left" pSortableColumn="url">
              <div class="flex items-center gap-2">
                URL
                <p-sortIcon field="url"></p-sortIcon>
              </div>
            </th>
            <th class="w-32 text-center" pSortableColumn="proxy_count">
              <div class="flex items-center justify-center gap-2">
                Proxy Count
                <p-sortIcon field="proxy_count"></p-sortIcon>
              </div>
            </th>
            <th class="w-48 text-center" pSortableColumn="added_at">
              <div class="flex items-center justify-center gap-2">
                Added At
                <p-sortIcon field="added_at"></p-sortIcon>
              </div>
            </th>
          </tr>
        </ng-template>

        <!-- Body Template -->
        <ng-template pTemplate="body" let-source let-rowIndex="rowIndex">
          <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors cursor-pointer"
              [ngClass]="{'bg-blue-50 dark:bg-blue-900/20': selectedSources.includes(source)}">

          <!-- Selection Checkbox -->
          <td class="text-center">
            <p-tableCheckbox [value]="source"></p-tableCheckbox>
          </td>

          <!-- URL Column -->
          <td class="max-w-0">
            <div class="flex items-center">
              <a
                [href]="source.url"
                target="_blank"
                rel="noopener noreferrer"
                class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300
                         hover:underline transition-colors truncate block max-w-full"
                [title]="source.url"
                (click)="$event.stopPropagation()">
                {{ source.url }}
              </a>
            </div>
          </td>

          <!-- Proxy Count Column -->
          <td class="text-center">
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                           bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300">
                {{ source.proxy_count }}
              </span>
          </td>

          <!-- Added At Column -->
          <td class="text-center text-gray-600 dark:text-gray-400">
            <div class="flex flex-col">
              <span class="font-medium">{{ source.added_at | date:'short' }}</span>
              <span class="text-xs text-gray-500 dark:text-gray-500">
                  {{ source.added_at | date:'MMM d, y' }}
                </span>
            </div>
          </td>
          </tr>
        </ng-template>

        <!-- Empty State -->
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="4" class="text-center py-12">
              <div class="flex flex-col items-center gap-4 text-gray-500 dark:text-gray-400">
                <i class="pi pi-inbox text-4xl"></i>
                <div>
                  <p class="text-lg font-medium">No scrape sources found</p>
                  <p class="text-sm">Add some scrape sources to get started</p>
                </div>
              </div>
            </td>
          </tr>
        </ng-template>

        <!-- Loading Template -->
        <ng-template pTemplate="loadingbody">
          <tr>
            <td colspan="4" class="text-center py-8">
              <div class="flex items-center justify-center gap-3">
                <i class="pi pi-spin pi-spinner text-2xl text-blue-500"></i>
                <span class="text-gray-600 dark:text-gray-400">Loading scrape sources...</span>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>

      <!-- Custom Paginator -->
      <div class="border-t border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 px-6 py-3">
        <p-paginator
          [first]="page * pageSize"
          [rows]="pageSize"
          [totalRecords]="totalItems"
          [rowsPerPageOptions]="[10, 20, 50, 100]"
          (onPageChange)="onPageChange($event)"
          class="border-0 bg-transparent">
        </p-paginator>
      </div>
    </div>
  </div>
}

<!-- Confirmation Dialog -->
<p-confirmDialog
  [style]="{width: '450px'}"
  [baseZIndex]="10000"
  rejectButtonStyleClass="p-button-outlined">
</p-confirmDialog>
