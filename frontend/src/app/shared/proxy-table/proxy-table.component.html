<p-table
  [value]="proxies"
  [paginator]="true"
  [rows]="pageSize"
  [first]="(page - 1) * pageSize"
  [totalRecords]="totalRecords"
  [lazy]="true"
  (onLazyLoad)="lazyLoad.emit($event)"
  [rowsPerPageOptions]="rowsPerPageOptions"
  [selection]="selectionEnabled ? selection : []"
  (selectionChange)="onSelectionChange($event)"
  dataKey="id"
  class="p-datatable-gridlines p-datatable-sm"
  [sortField]="sortable ? sortField : undefined"
  [sortOrder]="sortable ? (sortOrder ?? 0) : 0"
  (onSort)="onSort($event)"
  [loading]="loading"
  [showLoader]="hasLoaded"
  [rowTrackBy]="trackByProxy"
  [scrollable]="virtualScroll"
  [scrollHeight]="virtualScroll ? (scrollHeight ?? '60vh') : undefined"
  [virtualScroll]="virtualScroll"
  [virtualScrollItemSize]="virtualScroll ? virtualScrollItemSize : undefined"
>
  <ng-template pTemplate="header">
    <tr>
      @if (selectionEnabled) {
        <th style="width: 3rem">
          <p-checkbox
            [binary]="true"
            (onChange)="onMasterToggle()"
            [ngModel]="isAllSelected"
            [indeterminate]="isSomeSelected()"
          ></p-checkbox>
        </th>
      }

      @for (column of visibleColumns; track trackByColumn($index, column)) {
        @if (sortable && column.sortField) {
          <th
            [pSortableColumn]="column.sortField"
            [pTooltip]="column.tooltip ?? undefined"
            [tooltipDisabled]="!column.tooltip"
            tooltipPosition="top"
          >
            {{ column.label }} <p-sortIcon [field]="column.sortField"></p-sortIcon>
          </th>
        } @else {
          <th
            [pTooltip]="column.tooltip ?? undefined"
            [tooltipDisabled]="!column.tooltip"
            tooltipPosition="top"
          >
            {{ column.label }}
          </th>
        }
      }
    </tr>
  </ng-template>

  <ng-template pTemplate="loadingbody">
    @if (!hasLoaded) {
      @for (_ of skeletonRows; track $index) {
        <tr class="proxy-skeleton-row">
          @if (selectionEnabled) {
            <td>
              <p-skeleton width="1.25rem" height="1.25rem" shape="circle"></p-skeleton>
            </td>
          }

          @for (column of visibleColumns; track trackByColumn($index, column)) {
            <td>
              @if (column.id === 'alive') {
                <p-skeleton width="0.9rem" height="0.9rem" shape="circle"></p-skeleton>
              } @else if (column.id === 'reputation') {
                <div class="skeleton-badge">
                  <p-skeleton width="3.5rem" height="0.75rem"></p-skeleton>
                  <p-skeleton width="1.5rem" height="0.75rem"></p-skeleton>
                </div>
              } @else if (column.id === 'actions') {
                <p-skeleton width="4.5rem" height="1.5rem"></p-skeleton>
              } @else {
                <p-skeleton [width]="skeletonWidth(column)" height="0.75rem"></p-skeleton>
              }
            </td>
          }
        </tr>
      }
    }
  </ng-template>

  <ng-template pTemplate="body" let-proxy>
    <tr (click)="selectionEnabled ? onToggleSelection(proxy) : null" [pSelectableRow]="selectionEnabled ? proxy : undefined">
      @if (selectionEnabled) {
        <td (click)="$event.stopPropagation()">
          <p-checkbox
            [binary]="true"
            (onChange)="onToggleSelection(proxy)"
            [ngModel]="selectionModel?.isSelected(proxy)"
          ></p-checkbox>
        </td>
      }

      @for (column of visibleColumns; track trackByColumn($index, column)) {
        @switch (column.id) {
          @case ('alive') {
            <td>
              <div class="status-dot" [ngClass]="proxy.alive ? 'alive' : 'dead'"></div>
            </td>
          }
          @case ('health_overall') {
            <td class="text-center health-td">
              <app-health-bar-cell
                [aliveCount]="proxy.health?.overall ?? 0"
                [deadCount]="healthDeadPercent(proxy.health?.overall)"
                [unknownCount]="0"
                [showUnknown]="false"
                [total]="100"
                [hasData]="hasHealthValue(proxy.health?.overall)"
                valueSuffix="%"
                [valueDecimals]="1"
              ></app-health-bar-cell>
            </td>
          }
          @case ('health_http') {
            <td class="text-center health-td">
              <app-health-bar-cell
                [aliveCount]="proxy.health?.http ?? 0"
                [deadCount]="healthDeadPercent(proxy.health?.http)"
                [unknownCount]="0"
                [showUnknown]="false"
                [total]="100"
                [hasData]="hasHealthValue(proxy.health?.http)"
                valueSuffix="%"
                [valueDecimals]="1"
              ></app-health-bar-cell>
            </td>
          }
          @case ('health_https') {
            <td class="text-center health-td">
              <app-health-bar-cell
                [aliveCount]="proxy.health?.https ?? 0"
                [deadCount]="healthDeadPercent(proxy.health?.https)"
                [unknownCount]="0"
                [showUnknown]="false"
                [total]="100"
                [hasData]="hasHealthValue(proxy.health?.https)"
                valueSuffix="%"
                [valueDecimals]="1"
              ></app-health-bar-cell>
            </td>
          }
          @case ('health_socks4') {
            <td class="text-center health-td">
              <app-health-bar-cell
                [aliveCount]="proxy.health?.socks4 ?? 0"
                [deadCount]="healthDeadPercent(proxy.health?.socks4)"
                [unknownCount]="0"
                [showUnknown]="false"
                [total]="100"
                [hasData]="hasHealthValue(proxy.health?.socks4)"
                valueSuffix="%"
                [valueDecimals]="1"
              ></app-health-bar-cell>
            </td>
          }
          @case ('health_socks5') {
            <td class="text-center health-td">
              <app-health-bar-cell
                [aliveCount]="proxy.health?.socks5 ?? 0"
                [deadCount]="healthDeadPercent(proxy.health?.socks5)"
                [unknownCount]="0"
                [showUnknown]="false"
                [total]="100"
                [hasData]="hasHealthValue(proxy.health?.socks5)"
                valueSuffix="%"
                [valueDecimals]="1"
              ></app-health-bar-cell>
            </td>
          }
          @case ('ip') {
            <td>{{ proxy.ip }}</td>
          }
          @case ('ip_port') {
            <td>{{ proxy.ip }}:{{ proxy.port }}</td>
          }
          @case ('port') {
            <td>{{ proxy.port }}</td>
          }
          @case ('response_time') {
            <td>{{ proxy.response_time }} ms</td>
          }
          @case ('estimated_type') {
            <td>{{ proxy.estimated_type }}</td>
          }
          @case ('country') {
            <td>{{ proxy.country }}</td>
          }
          @case ('reputation') {
            <td class="reputation-cell">
              @if (proxy.__meta?.hasReputation) {
                <span [ngClass]="proxy.__meta?.reputationBadgeClass">
                  <span>{{ proxy.__meta?.reputationLabel }}</span>
                  <span class="reputation-badge__score">{{ proxy.__meta?.reputationScore }}</span>
                </span>
              } @else {
                {{ emptyReputationLabel }}
              }
            </td>
          }
          @case ('latest_check') {
            <td class="w-[170px]">
              {{ proxy.__meta?.latestCheckLabel ?? 'â€”' }}
            </td>
          }
          @case ('actions') {
            <td>
              <button type="button" class="proxy-details-button" (click)="onViewProxy($event, proxy)">
                <i class="pi pi-external-link" aria-hidden="true"></i>
                <span>Details</span>
              </button>
            </td>
          }
        }
      }
    </tr>
  </ng-template>

  <ng-template pTemplate="emptyMessage">
    <tr>
      <td [attr.colspan]="columnCount">No proxies found.</td>
    </tr>
  </ng-template>
</p-table>
